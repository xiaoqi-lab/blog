---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import { getTranslation } from '../../i18n/index';

// Get language from locals (set by middleware) or from URL path
let lang = Astro.locals.lang;
if (!lang) {
  // Fallback: check URL path
  if (Astro.url.pathname.startsWith('/zh')) {
    lang = 'zh';
  } else {
    lang = 'en';
  }
}
const t = getTranslation(lang);

const posts = (await getCollection('blog'))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 2); // 只显示最新的2篇文章
---

<section class="bg-primary">
  <div class="px-8 2xl:max-w-7xl mx-auto py-32">
    <div class="space-y-2 mb-16">
      <div
        class="h-0.5 bg-secondary"
        data-aos="fade-up"
        data-aos-duration="1000">
      </div>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
        <h3
          class="text-secondary text-base font-medium"
          data-aos="fade-up"
          data-aos-duration="1500">
          <span>{t.blog.title}</span>
        </h3>
        <a
          href={lang === 'en' ? '/blog' : '/zh/blog'}
          class="text-secondary text-xs font-medium hover:text-secondary/80 underline underline-offset-4 transition-colors"
          data-aos="fade-up"
          data-aos-duration="1500">
          {t.blog.viewAllPosts} →
        </a>
      </div>
      <div
        class="h-1.5 bg-secondary"
        data-aos="fade-up"
        data-aos-duration="2000">
      </div>
    </div>

    {posts.length > 0 ? (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
        {
          posts.map((post, index) => (
            <a
              href={lang === 'en' ? `/blog/${post.id}/` : `/zh/blog/${post.id}/`}
              class="group block text-secondary"
              data-aos="fade-up"
              data-aos-duration={1500 + index * 500}
            >
              <article class="h-full flex flex-col">
                {post.data.heroImage && (
                  <div class="mb-6 overflow-hidden rounded">
                    <Image
                      width={720}
                      height={360}
                      src={post.data.heroImage}
                      alt={post.data.title}
                      class="w-full h-auto group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                )}
                <div class="flex-1 flex flex-col">
                  <time class="text-xs text-secondary/60 mb-3">
                    {new Date(post.data.pubDate).toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                  <h4 class="text-2xl lg:text-3xl font-bold mb-3 group-hover:text-secondary/80 transition-colors">
                    {post.data.title}
                  </h4>
                  {post.data.description && (
                    <p class="text-base text-secondary/70 mb-4 line-clamp-3">
                      {post.data.description}
                    </p>
                  )}
                  <span class="text-xs font-medium text-secondary/60 group-hover:text-secondary transition-colors mt-auto">
                    {t.blog.readMore} →
                  </span>
                </div>
              </article>
            </a>
          ))
        }
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-secondary/60 text-lg mb-4">{t.blog.noPosts}</p>
        <a
          href={lang === 'en' ? '/blog' : '/zh/blog'}
          class="text-secondary text-sm underline underline-offset-4 hover:text-secondary/80">
          {t.blog.visitBlog} →
        </a>
      </div>
    )}
  </div>
</section>

