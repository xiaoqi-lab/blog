---
interface Props {
  currentLang: 'en' | 'zh';
}

const { currentLang } = Astro.props;
const otherLang = currentLang === 'en' ? 'zh' : 'en';
const otherLangLabel = otherLang === 'en' ? 'English' : '中文';
---

<div class="language-switcher">
  <button
    id="lang-switcher"
    class="text-secondary hover:text-secondary/80 transition-colors"
    data-current-lang={currentLang}
    data-other-lang={otherLang}
    aria-label={`Switch to ${otherLangLabel}`}
    title={`Switch to ${otherLangLabel}`}
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 0 1-3.827-5.802" />
    </svg>
  </button>
</div>

<script is:inline>
  (function() {
    const button = document.getElementById('lang-switcher');
    if (button) {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const currentLang = button.getAttribute('data-current-lang');
        const otherLang = button.getAttribute('data-other-lang');
        
        if (!otherLang) return;
        
        // Save preference to both localStorage and cookie
        localStorage.setItem('preferred-language', otherLang);
        
        // Set cookie for server-side middleware
        document.cookie = `preferred-language=${otherLang}; path=/; max-age=31536000`; // 1 year
        
        // Get current path
        const currentPath = window.location.pathname;
        
        // Remove existing language prefix
        let newPath = currentPath.replace(/^\/(en|zh)/, '') || '/';
        
        // Ensure path starts with /
        if (!newPath.startsWith('/')) {
          newPath = '/' + newPath;
        }
        
        // Handle root path
        if (newPath === '/') {
          if (otherLang === 'zh') {
            newPath = '/zh';
          } else {
            newPath = '/';
          }
        } else {
          // Add new language prefix (only if not default 'en')
          if (otherLang === 'zh') {
            newPath = '/zh' + newPath;
          }
          // For English, keep path without /en prefix (default)
        }
        
        // Reload page with new language
        window.location.href = newPath;
      });
    }
  })();
</script>

<style>
  .language-switcher {
    display: inline-flex;
    align-items: center;
  }
  
  .language-switcher button {
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
    border: none;
    background: transparent;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .language-switcher button:hover {
    opacity: 0.8;
  }
  
  .language-switcher button svg {
    width: 1rem;
    height: 1rem;
  }
</style>

